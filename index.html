<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>DEFI-OS</title>
    <link href="assets/os/datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css">
    <link rel="stylesheet"
        href="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.css">
    <link rel="stylesheet" href="assets/os/assets/leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.css">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.13.4/codemirror.css'>
    <link rel="stylesheet" href="assets/os/draw/leaflet.draw.css" />
    <link rel="stylesheet" href="assets/os/assets/css/Control.Geocoder.css">
    <link rel="stylesheet" href="assets/os/assets/css/app.css">

    <link rel="apple-touch-icon" sizes="76x76" href="assets/os/assets/img/favicon-76.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/os/assets/img/favicon-120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/os/assets/img/favicon-152.png">
    <link rel="icon" sizes="196x196" href="assets/os/assets/img/favicon-196.png">
    <link rel="icon" type="image/x-icon" href="assets/os/assets/img/favicon.ico">
</head>

<body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container-fluid">
            <div class="navbar-header">
                <div class="navbar-icon-container">
                    <a href="#" class="navbar-icon pull-right visible-xs" id="nav-btn"><i
                            class="fa fa-caret fa-lg "></i></a>
                    <a href="#" class="navbar-icon pull-right visible-xs" id="sidebar-toggle-btn"><i
                            class="fa fa-bars fa-lg"></i></a>
                </div>
                <a class="navbar-brand" href="#"><img src="assets/os/img/logo.png"
                        style="height:50px;margin-top: -15px;"> </a>
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <!-- <li><a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" id="about-btn"><i
                class="fa fa-home-circle"></i>&nbsp;&nbsp;Home</a></li> -->
                    <li class="hidden-xs"><a href="#" data-toggle="collapse" data-target=".navbar-collapse.in"
                            id="list-btn"><i class="fa fa-list white"></i>&nbsp;&nbsp;Sidebar</a></li>
                    <li class="hidden-xs"><a href="#aboutModal" data-toggle="modal"><i
                                class="fa fa-question-circle"></i>&nbsp;&nbsp;How To Use</a></li>
                </ul>


            </div>
            <!--/.navbar-collapse -->
        </div>
    </div>
    <div id="container">
        <div id="sidebar">
            <div class="sidebar-wrapper">
                <div class="panel panel-default" id="features">
                    <div class="panel-heading">
                        <h3 class="panel-title">Navigation Window
                            <button type="button" class="btn btn-xs btn-default pull-right" id="sidebar-hide-btn"><i
                                    class="fa fa-chevron-left"></i></button>
                        </h3>
                    </div>
                    <div class="panel-body">
                        <div id="results">
                            <ul class="nav nav-tabs">
                                <li class="active"><a data-toggle="tab" href="#home">Area</a></li>
                                <li><a data-toggle="tab" href="#parameters">Parameters</a></li>
                                <li><a data-toggle="tab" href="#api">Specification</a></li>
                                <li><a data-toggle="tab" href="#smart">Smart Contract Code</a></li>

                            </ul>

                            <div class="tab-content">
                                <div id="home" class="tab-pane fade in active">
                                    <textarea id="code" name="code"></textarea>
                                    <!-- <div id="code" style="width: 100%; height: auto;"></div> -->
                                </div>
                                <div id="parameters" class="tab-pane">
                                    <div class="row">
                                        <div class="col-md-8" style="margin-left:15px;">
                                            <form id="paramsForm">
                                                <label for="dataset">Dataset <span
                                                        class="asteriskField">*</span></label>
                                                <select id="dataset" class="form-control" required>
                                                    <option value="">--------------------------</option>
                                                </select>
                                                <br>
                                                <label for="bands">Available bands <span
                                                        class="asteriskField">*</span></label>
                                                <select id="bands" class="form-control" required>
                                                    <option value="">--------------------------</option>
                                                </select>
                                                <br>
                                                <label for="scale">Preferred Scale <span
                                                        class="asteriskField">*</span></label>
                                                <input id="scale" type="number" class="form-control" required />
                                                <br>
                                                <label for="stats">Statistics <span
                                                        class="asteriskField">*</span></label>
                                                <select id="stats" class="form-control" required>
                                                    <option value="">--------------------------</option>
                                                    <option value="min">Min</option>
                                                    <option value="max">Max</option>
                                                    <option value="median">Median</option>
                                                    <option value="mean">Mean</option>
                                                    <option value="variance">Variance</option>
                                                </select>
                                                <br>
                                                <!-- <label for="threshold">Threshold <span class="asteriskField">*</span></label>
                                <input id="threshold" type="number" class="form-control" required />
                                <br> -->

                                                <div id="div_id_start_date" class="form-group">
                                                    <label for="id_start_date" class=" requiredField">Start date <span
                                                            class="asteriskField">*</span> </label>
                                                    <div class=""> <input type="text" name="start_date"
                                                            class="dateinput form-control" required id="id_start_date">
                                                    </div>
                                                </div>
                                                <div id="div_id_end_date" class="form-group">
                                                    <label for="id_end_date" class=" requiredField">End date <span
                                                            class="asteriskField">*</span> </label>
                                                    <div class=""> <input type="text" name="end_date"
                                                            class="dateinput form-control" required id="id_end_date">
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="buttonHolder">
                                                    <input type="submit" name="submit" value="Submit"
                                                        class="btn btn-primary btn btn-primary" id="submit-id-submit" />

                                                </div>

                                            </form>


                                        </div>
                                    </div>

                                </div>
                                <div id="api" class="tab-pane">
                                    <textarea id="apicode" name="apicode"></textarea>
                                </div>
                                <div id="smart" class="tab-pane">
                                    <button class="btn btn-primary clip-btn-jquery btn-rounded" data-toggle="tooltip"
                                        title="Copy">
                                        <span class="fa fa-copy"> Copy</span>
                                    </button>
                                    <textarea id="smartcode" name="smartcode"></textarea>

                                </div>

                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div id="map"></div>

    </div>
    <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">How To Use This Tool</h4>
                </div>
                <div class="modal-body">
                    <ol class="list-style-5">
                        <li>Use the search tool to find the general area of interest.</li>
                        <li>Use the draw tools to specify the boundary of the area.</li>
                        <li>Use the form on the parameters tab to input your specs.</li>
                        <li>Find the specifications codified in the smart contract tab.</li>
                    </ol>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="assets/os/datepicker/js/bootstrap-datepicker.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.10.5/typeahead.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.1.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>

    <script
        src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
    <script
        src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.min.js"></script>
    <script src="assets/os/assets/leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.js"></script>
    <script src="assets/os/draw/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>

    <script src="assets/os/codemirror/codemirror.js"></script>
    <script src="assets/os/codemirror/javascript.js"></script>
    <script src="assets/os/codemirror/active-line.js"></script>
    <script src="assets/os/codemirror/matchbrackets.js"></script>
    <script src="assets/os/codemirror/foldcode.js"></script>
    <script src="assets/os/assets/js/Control.Geocoder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.4.2/clipboard.min.js"></script>
    <script src="assets/os/assets/js/app.js"></script>
    <script src="assets/os/assets/js/datasets.js"></script>
    <script src="assets/os/assets/js/code.js"></script>
    <script type="text/javascript">

        $('#id_start_date').datepicker({
            autoclose: true,
            todayHighlight: true,
            changeMonth: true,
            changeYear: true,
            format: 'yyyy-mm-dd',
            // endDate: new Date()
        }).on('changeDate', function (selected) {
            var minDate = new Date(selected.date.valueOf());
            $('#id_end_date').datepicker('setStartDate', minDate);
        });
        $('#id_end_date').datepicker({
            autoclose: true,
            todayHighlight: true,
            changeMonth: true,
            changeYear: true,
            format: 'yyyy-mm-dd',
            // endDate: new Date()
        }).on('changeDate', function (selected) {
            var maxDate = new Date(selected.date.valueOf());
            $('#id_start_date').datepicker('setEndDate', maxDate);
        });
        var editor, seditor;
        $(function () {
            editor = CodeMirror.fromTextArea(document.getElementById("code"), {
                lineNumbers: true,
                styleActiveLine: true,
                matchBrackets: true,
                mode: 'text/javascript',
                lineWrapping: false,
                extraKeys: { "Ctrl-Q": function (cm) { cm.foldCode(cm.getCursor()) } },
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
            });
            seditor = CodeMirror.fromTextArea(document.getElementById("apicode"), {
                lineNumbers: true,
                styleActiveLine: true,
                matchBrackets: true,
                autoCloseTags: true,
                autoRefresh: true,
                autofocus: true,
                mode: '"text/plain"',
                lineWrapping: true,
                extraKeys: { "Ctrl-Q": function (cm) { cm.foldCode(cm.getCursor()) } },
                foldGutter: true,
                // gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
            });
            smarteditor = CodeMirror.fromTextArea(document.getElementById("smartcode"), {
                lineNumbers: true,
                autoCloseTags: true,
                autoRefresh: true,
                autofocus: true,
                mode: 'application/html',
                lineWrapping: true,
            });
            // setTimeout(seditor.refresh, 1)
        });

        $(document).on('submit', '#paramsForm', function (e) {
            if (editor.doc.getValue()) {
                e.preventDefault();
                var outputCode = {
                    "dataset": $('#dataset').val(),
                    "band": $('#bands').val(),
                    "scale": $('#scale').val(),
                    "start_date": $('#id_start_date').val(),
                    "end_date": $('#id_end_date').val(),
                    // "output": "time_series",
                    "geometry": JSON.parse(editor.doc.getValue())
                }
                seditor.setValue(JSON.stringify(outputCode));
                seditor.setOption('mode', 'javascript');
                $('a[href="#api"]').click();
                $("#apicode").focus();
                setTimeout(function () {
                    seditor.refresh();
                }, 1);
                // Generate smart contract
                var b = '{\"agg_x\" : "' + 'agg_' + $("#stats").val() + '",' +
                    '\"dataset_code\" : "' + $("#dataset").val() + '",' +
                    '\"selected_band\" : "' + $("#bands").val() + '",' +
                    '\"image_scale\" : ' + $("#scale").val() + ',' +
                    '\"start_date\" : "' + $("#id_start_date").val() + '",' +
                    '\"end_date\" : "' + $("#id_end_date").val() + '",' +
                    '\"geometry\" : ' + JSON.stringify(JSON.parse(editor.doc.getValue())) + '}'

                let firstBlockText;
                let lastBlockText;
                const getCodeBlocks = async () => {
                    firstBlockText = firstBlock;
                    lastBlockText = lastBlock
                };
                window.onload = e => getCodeBlocks();
                var finalCode = firstBlock + JSON.stringify(b) + lastBlock
                smarteditor.setValue(finalCode);
                $('#paramsForm').trigger("reset");

            }
            else {
                e.preventDefault();
                alert('Make sure you have drawn an area on the map');
            }

        });
        $('.nav-tabs a').on('shown.bs.tab', function () {
            editor.refresh();
            seditor.refresh();
            smarteditor.refresh();
        });
        $(function () {
            var editorSelector = '#smarteditor'
            // Instantiate Bootstrap tooltips.
            $('[data-toggle="tooltip"]').tooltip();

            new Clipboard('.clip-btn-jquery', {
                text: function (trigger) {
                    return smarteditor.doc.getValue();
                }
            });


        });







    </script>
    <script type="text/javascript">
        $(window).on('load', function () {
            $('#aboutModal').modal('show');
        });
    </script>

    <script>
        let datasets;
        let selectedDataset;
        const datasetSelector = document.querySelector('#dataset');
        const scaleInput = document.querySelector('#scale');
        const bandSelector = document.querySelector('#bands');

        const removeChildren = parent => {
            while (parent.firstChild) {
                parent.removeChild(parent.firstChild);
            }
        }

        const renderDropdown = () => {
            for (let dataset of datasets) {
                const option = document.createElement('option');
                option.innerHTML = dataset.name;
                option.value = dataset.code;

                datasetSelector.appendChild(option);
            }
        };

        const fetchDatasets = async () => {
            // Make API call here

            datasets = data;

            renderDropdown();
        };

        const updateForm = () => {
            scaleInput.value = selectedDataset.preferred_scale;

            removeChildren(bandSelector);
            for (let band of selectedDataset.available_bands) {
                const option = document.createElement('option');
                option.innerHTML = band;
                option.value = band;

                bandSelector.appendChild(option);
            }
        }

        datasetSelector.addEventListener('change', e => {
            if (e.target.value) {
                const matches = datasets.filter(dataset => dataset.code == e.target.value);
                selectedDataset = matches[0];

                updateForm();
            }
        });

        window.onload = e => fetchDatasets();

    </script>

    <!-- <script src="assets/os/custom/modals.js'%}"></script> -->
</body>

</html>