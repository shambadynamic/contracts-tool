<!DOCTYPE html>
<html lang="en">
{% load static %}
{% load crispy_forms_tags %}

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>DEFI-OS</title>
    <link href="{% static 'os/datepicker/css/bootstrap-datepicker.min.css' %}" rel="stylesheet" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css">
    <link rel="stylesheet"
        href="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css">
    <link rel="stylesheet"
        href="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css">
    <link rel="stylesheet"
        href="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.css">
    <link rel="stylesheet" href="{% static 'os/assets/leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.css' %}">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.13.4/codemirror.css'>
    <link rel="stylesheet" href="{% static 'os/draw/leaflet.draw.css' %}" />
    <link rel="stylesheet" href="{% static 'os/assets/css/app.css' %}">

    <link rel="apple-touch-icon" sizes="76x76" href="{% static 'os/assets/img/favicon-76.png' %}">
    <link rel="apple-touch-icon" sizes="120x120" href="{% static 'os/assets/img/favicon-120.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'os/assets/img/favicon-152.png' %}">
    <link rel="icon" sizes="196x196" href="{% static 'os/assets/img/favicon-196.png' %}">
    <link rel="icon" type="image/x-icon" href="{% static 'os/assets/img/favicon.ico' %}">
</head>

<body>
    <div id="container">
        <div id="map"></div>
        <div id="results">
            <ul class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#home">JSON</a></li>
                <li><a data-toggle="tab" href="#parameters">Parameters</a></li>
                <li><a data-toggle="tab" href="#smart">Code</a></li>
                <li><a data-toggle="tab" href="#menu2">Help</a></li>
                <!-- <a href="#" class="btn btn-primary" style="float: right;margin-top: 2px; margin-right: 15px;"
                    id="generateCode">Generate
                    Smart Code</a> -->
            </ul>

            <div class="tab-content">
                <div id="home" class="tab-pane fade in active">
                    <textarea id="code" name="code"></textarea>
                    <!-- <div id="code" style="width: 100%; height: auto;"></div> -->
                </div>
                <div id="parameters" class="tab-pane">
                    <div class="row">
                        <div class="col-md-8" style="margin-left:15px;">
                            <form method="post" id="form-data" enctype="multipart/form-data">
                                {% csrf_token %}
                                {% crispy form %}
                            </form>
                            <!-- <hr>
                            <a href="#" class="btn btn-primary"
                                style="float: right;margin-top: 2px; margin-right: 15px;" id="generateCode">Generate
                                Smart Code</a> -->
                        </div>
                    </div>

                </div>
                <div id="smart" class="tab-pane">
                    <textarea id="smartcode" name="smartcode"></textarea>
                </div>
                <div id="menu2" class="tab-pane">
                    Details will go here
                </div>
            </div>

        </div>



    </div>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="{% static 'os/datepicker/js/bootstrap-datepicker.min.js' %}"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.10.5/typeahead.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.1.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>

    <script
        src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
    <script
        src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.min.js"></script>
    <script src="{% static 'os/assets/leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.js' %}"></script>
    <script src="{% static 'os/draw/leaflet.draw.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>

    <script src="{% static 'os/codemirror/codemirror.js' %}"></script>
    <script src="{% static 'os/codemirror/javascript.js' %}"></script>
    <script src="{% static 'os/codemirror/active-line.js' %}"></script>
    <script src="{% static 'os/codemirror/matchbrackets.js' %}"></script>
    <script src="{% static 'os/codemirror/foldcode.js' %}"></script>
    <script src="{% static 'os/assets/js/app.js' %}"></script>
    <script type="text/javascript">

        $('#id_start_date').datepicker({
            autoclose: true,
            todayHighlight: true,
            changeMonth: true,
            changeYear: true,
            format: 'yyyy-mm-dd'
        });
        $('#id_end_date').datepicker({
            autoclose: true,
            todayHighlight: true,
            changeMonth: true,
            changeYear: true,
            format: 'yyyy-mm-dd'
        });
        var editor, seditor;
        $(function () {
            editor = CodeMirror.fromTextArea(document.getElementById("code"), {
                lineNumbers: true,
                styleActiveLine: true,
                matchBrackets: true,
                mode: 'text/javascript',
                lineWrapping: false,
                extraKeys: { "Ctrl-Q": function (cm) { cm.foldCode(cm.getCursor()) } },
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
            });
            seditor = CodeMirror.fromTextArea(document.getElementById("smartcode"), {
                lineNumbers: true,
                styleActiveLine: true,
                matchBrackets: true,
                autoCloseTags: true,
                autoRefresh: true,
                autofocus: true,
                mode: 'javascript',
                lineWrapping: true,
                extraKeys: { "Ctrl-Q": function (cm) { cm.foldCode(cm.getCursor()) } },
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
            });
            setTimeout(seditor.refresh, 1)
        });

        $(document).ready(function () {
            $('#generateCode').prop('disabled', true);
        });

    </script>
    <script type="text/javascript">
        $(document).on('submit', '#form-data', function (e) {
            e.preventDefault();
            var outputCode = {
                "dataset_code": $('#id_data_code').val(),
                "selected_band": $('#id_band').val(),
                "image_scale": $('#id_scale').val(),
                "start_date": $('#id_start_date').val(),
                "end_date": $('#id_end_date').val(),
                "output": "time_series",
                "geometry": JSON.parse(editor.doc.getValue())
            }
            seditor.setValue(JSON.stringify(outputCode, null, 4));
            seditor.setOption('mode', 'javascript');
            console.log('The codes', JSON.parse(seditor.doc.getValue()))

            $.ajax({
                url: '/queries/',
                type: 'POST',
                data: {
                    "dataset_code": $('#id_data_code').val(),
                    "selected_band": $('#id_band').val(),
                    "image_scale": $('#id_scale').val(),
                    "start_date": $('#id_start_date').val(),
                    "end_date": $('#id_end_date').val(),
                    "output": "time_series",
                    "query": seditor.doc.getValue(),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()

                },
                success: function (data) {
                    alert('Query saved')
                }
            });

            setTimeout(function () {
                seditor.refresh();
            }, 1);
            $('a[href="#smart"]').click();
        });


    </script>
    <!-- <script src="{% static 'os/custom/modals.js'%}"></script> -->
</body>

</html>