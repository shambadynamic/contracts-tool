<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>DEFI-OS</title>
    <link href="assets/os/datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css">
    <link rel="stylesheet"
        href="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css">
    <link rel="stylesheet"
        href="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css">
    <link rel="stylesheet"
        href="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.css">
    <link rel="stylesheet" href="assets/os/assets/leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.css">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.13.4/codemirror.css'>
    <link rel="stylesheet" href="assets/os/draw/leaflet.draw.css" />
    <link rel="stylesheet" href="assets/os/assets/css/Control.Geocoder.css">
    <link rel="stylesheet" href="assets/os/assets/css/app.css">

    <link rel="apple-touch-icon" sizes="76x76" href="assets/os/assets/img/favicon-76.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/os/assets/img/favicon-120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/os/assets/img/favicon-152.png">
    <link rel="icon" sizes="196x196" href="assets/os/assets/img/favicon-196.png">
    <link rel="icon" type="image/x-icon" href="assets/os/assets/img/favicon.ico">
</head>

<body>
    <div id="container">
        <div id="map"></div>
        <div id="results">
            <ul class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#home">JSON</a></li>
                <li><a data-toggle="tab" href="#parameters">Parameters</a></li>
                <li><a data-toggle="tab" href="#api">API Request</a></li>
                <li><a data-toggle="tab" href="#smart">Smart Contract Code</a></li>
                <!-- <li><a data-toggle="tab" href="#menu2">Help</a></li> -->
                <a class="btn" data-toggle="modal" href="#aboutModal"
                    style="float: right;margin-top: 2px; margin-right: 15px;"><i class="fa fa-question-circle"></i>
                    About
                    DEFI</a>
            </ul>

            <div class="tab-content">
                <div id="home" class="tab-pane fade in active">
                    <textarea id="code" name="code"></textarea>
                    <!-- <div id="code" style="width: 100%; height: auto;"></div> -->
                </div>
                <div id="parameters" class="tab-pane">
                    <div class="row">
                        <div class="col-md-8" style="margin-left:15px;">
                            <form id="paramsForm">

                                <label for="dataset">Dataset <span class="asteriskField">*</span></label>
                                <select id="dataset" class="form-control" required>
                                    <option value="">--------------------------</option>
                                </select>
                                <br>
                                <label for="bands">Available bands <span class="asteriskField">*</span></label>
                                <select id="bands" class="form-control" required>
                                    <option value="">--------------------------</option>
                                </select>
                                <br>
                                <label for="scale">Preferred Scale <span class="asteriskField">*</span></label>
                                <input id="scale" type="number" class="form-control" required />
                                <br>
                                <label for="stats">Statistics <span class="asteriskField">*</span></label>
                                <select id="stats" class="form-control" required>
                                    <option value="">--------------------------</option>
                                    <option value="Min">Min</option>
                                    <option value="Max">Max</option>
                                    <option value="Median">Median</option>
                                    <option value="Mean">Mean</option>
                                    <option value="Variance">Variance</option>
                                </select>
                                <br>
                                <label for="threshold">Threshold <span class="asteriskField">*</span></label>
                                <input id="threshold" type="number" class="form-control" required />
                                <br>

                                <div id="div_id_start_date" class="form-group">
                                    <label for="id_start_date" class=" requiredField">Start date <span
                                            class="asteriskField">*</span> </label>
                                    <div class=""> <input type="text" name="start_date" class="dateinput form-control"
                                            required id="id_start_date"> </div>
                                </div>
                                <div id="div_id_end_date" class="form-group">
                                    <label for="id_end_date" class=" requiredField">End date <span
                                            class="asteriskField">*</span> </label>
                                    <div class=""> <input type="text" name="end_date" class="dateinput form-control"
                                            required id="id_end_date"></div>
                                </div>
                                <hr>
                                <div class="buttonHolder">
                                    <input type="submit" name="submit" value="Submit"
                                        class="btn btn-primary btn btn-primary" id="submit-id-submit" />

                                </div>

                            </form>


                        </div>
                    </div>

                </div>
                <div id="api" class="tab-pane">
                    <textarea id="apicode" name="apicode"></textarea>
                </div>
                <div id="smart" class="tab-pane">
                    <textarea id="smartcode" name="smartcode"></textarea>
                </div>

            </div>

        </div>
        <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">About Defi</h4>
                    </div>
                    <div class="modal-body">
                        <p>DEFI simply means awesomeness. Btw thats true!!</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->


    </div>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="assets/os/datepicker/js/bootstrap-datepicker.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.10.5/typeahead.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.1.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>

    <script
        src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
    <script
        src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.min.js"></script>
    <script src="assets/os/assets/leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.js"></script>
    <script src="assets/os/draw/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>

    <script src="assets/os/codemirror/codemirror.js"></script>
    <script src="assets/os/codemirror/javascript.js"></script>
    <script src="assets/os/codemirror/active-line.js"></script>
    <script src="assets/os/codemirror/matchbrackets.js"></script>
    <script src="assets/os/codemirror/foldcode.js"></script>
    <script src="assets/os/assets/js/Control.Geocoder.js"></script>
    <script src="assets/os/assets/js/app.js"></script>
    <script src="assets/os/assets/js/datasets.js"></script>
    <script src="assets/os/assets/js/code.js"></script>
    <script type="text/javascript">

        $('#id_start_date').datepicker({
            autoclose: true,
            todayHighlight: true,
            changeMonth: true,
            changeYear: true,
            format: 'yyyy-mm-dd'
        });
        $('#id_end_date').datepicker({
            autoclose: true,
            todayHighlight: true,
            changeMonth: true,
            changeYear: true,
            format: 'yyyy-mm-dd'
        });
        var editor, seditor;
        $(function () {
            editor = CodeMirror.fromTextArea(document.getElementById("code"), {
                lineNumbers: true,
                styleActiveLine: true,
                matchBrackets: true,
                mode: 'text/javascript',
                lineWrapping: false,
                extraKeys: { "Ctrl-Q": function (cm) { cm.foldCode(cm.getCursor()) } },
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
            });
            seditor = CodeMirror.fromTextArea(document.getElementById("apicode"), {
                lineNumbers: true,
                styleActiveLine: true,
                matchBrackets: true,
                autoCloseTags: true,
                autoRefresh: true,
                autofocus: true,
                mode: 'javascript',
                lineWrapping: true,
                extraKeys: { "Ctrl-Q": function (cm) { cm.foldCode(cm.getCursor()) } },
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
            });
            smarteditor = CodeMirror.fromTextArea(document.getElementById("smartcode"), {
                lineNumbers: true,
                styleActiveLine: true,
                matchBrackets: true,
                autoCloseTags: true,
                autoRefresh: true,
                autofocus: true,
                mode: 'javascript',
                lineWrapping: true,
                extraKeys: { "Ctrl-Q": function (cm) { cm.foldCode(cm.getCursor()) } },
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
            });
            // setTimeout(seditor.refresh, 1)
        });

        $(document).on('submit', '#paramsForm', function (e) {
            e.preventDefault();
            console.log('Editor content', editor.doc.getValue())
            var outputCode = {
                "dataset": $('#dataset').val(),
                "band": $('#bands').val(),
                "scale": $('#scale').val(),
                "start_date": $('#id_start_date').val(),
                "end_date": $('#id_end_date').val(),
                // "output": "time_series",
                "statistics": $('#stats').val(),
                "geometry": JSON.parse(editor.doc.getValue())
            }
            seditor.setValue(JSON.stringify(outputCode, null, 4));
            seditor.setOption('mode', 'javascript');
            console.log(seditor.doc.getValue())


            $('a[href="#api"]').click();
            $("#apicode").focus();
            seditor.refresh();

            // Generate smart contract
            var b = "\nuint256 dataset_code = '" + $('#dataset').val() +
                "';\n" + "uint256 selected_band = '" + $('#bands').val() + "';\n" +
                "uint256 image_scale = " + ($('#scale').val() * 100) + ";\n" +
                "uint256 start_date = '" + $('#id_start_date').val() + "';\n" +
                "uint256 end_date = '" + $('#id_end_date').val() + "';\n" +
                "uint256 output = " + "'aggregate'" + ";\n" +
                "uint256 geometry = " + editor.doc.getValue() + ";\n" +
                "uint256 jobid = '" + $('#stats').val() + "';\n" + "uint256 threshold = " + $('#threshold').val() + ";\n"
            console.log('This is the smart code', b)
            let firstBlockText;
            let lastBlockText;
            const getCodeBlocks = async () => {
                firstBlockText = firstBlock;
                lastBlockText = lastBlock
            };
            window.onload = e => getCodeBlocks();
            console.log('First block', firstBlockText)

            var finalCode = firstBlock + b + lastBlock

            smarteditor.setValue(finalCode);
            // smarteditor.setOption('mode', 'javascript');
            console.log(smarteditor.doc.getValue())


            $('#paramsForm').trigger("reset");

        });
        // setTimeout(function () {
        //     seditor.refresh();
        // }, 1);




    </script>
    <script type="text/javascript">
        $(window).on('load', function () {
            $('#aboutModal').modal('show');
        });
    </script>

    <script>
        let datasets;
        let selectedDataset;
        const datasetSelector = document.querySelector('#dataset');
        const scaleInput = document.querySelector('#scale');
        const bandSelector = document.querySelector('#bands');

        const removeChildren = parent => {
            while (parent.firstChild) {
                parent.removeChild(parent.firstChild);
            }
        }

        const renderDropdown = () => {
            for (let dataset of datasets) {
                const option = document.createElement('option');
                option.innerHTML = dataset.name;
                option.value = dataset.code;

                datasetSelector.appendChild(option);
            }
        };

        const fetchDatasets = async () => {
            // Make API call here

            datasets = data;

            renderDropdown();
        };

        const updateForm = () => {
            scaleInput.value = selectedDataset.preferred_scale;

            removeChildren(bandSelector);
            for (let band of selectedDataset.available_bands) {
                const option = document.createElement('option');
                option.innerHTML = band;
                option.value = band;

                bandSelector.appendChild(option);
            }
        }

        datasetSelector.addEventListener('change', e => {
            if (e.target.value) {
                const matches = datasets.filter(dataset => dataset.code == e.target.value);
                selectedDataset = matches[0];

                updateForm();
            }
        });

        window.onload = e => fetchDatasets();

    </script>
    <!-- <script src="assets/os/custom/modals.js'%}"></script> -->
</body>

</html>